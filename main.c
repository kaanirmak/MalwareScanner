#include <stdio.h>
#include <stdlib.h>
#include <dirent.h>
#include <string.h>
#include <yara.h>

#define RULES_FILE "malware.yar"

void scan_directory(const char *dir_path, YR_RULES *rules)
{
    DIR *dir;
    struct dirent *ent;

    if ((dir = opendir(dir_path)) == NULL) {
        perror("Hata");
        return;
    }

    while ((ent = readdir(dir)) != NULL) {
        if (strcmp(ent->d_name, ".") == 0 || strcmp(ent->d_name, "..") == 0) {
            continue;
        }

        char file_path[1024];
        sprintf(file_path, "%s/%s", dir_path, ent->d_name);

        FILE *file = fopen(file_path, "rb");
        if (file == NULL) {
            perror("Hata");
            continue;
        }

        YR_SCAN_RESULTS *results;

        if (yr_rules_scan_file(rules, file, 0, &results) != ERROR_SUCCESS) {
            perror("Hata");
            fclose(file);
            continue;
        }

        if (results->matches > 0) {
            printf("Zararlý dosya tespit edildi: %s\n", file_path);
        }

        yr_scan_results_destroy(results);
        fclose(file);
    }

    closedir(dir);
}

int main(int argc, char **argv)
{
    if (argc != 2) {
        printf("Kullaným: %s <dizin>\n", argv[0]);
        exit(EXIT_FAILURE);
    }

    YR_RULES *rules;

    if (yr_initialize() != ERROR_SUCCESS) {
        printf("Yara baþlatýlamadý.\n");
        exit(EXIT_FAILURE);
    }

    if (yr_rules_load(RULES_FILE, &rules) != ERROR_SUCCESS) {
        printf("Kural dosyasý yüklenemedi.\n");
        yr_finalize();
        exit(EXIT_FAILURE);
    }

    scan_directory(argv[1], rules);

    yr_rules_destroy(rules);
    yr_finalize();

    return 0;
}
